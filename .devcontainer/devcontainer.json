// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/docker-existing-dockerfile
{
	"name": "webdriver-precore",
	"image": "ghcr.io/pyrethrum/webdriver-precore-firefox:latest",

	// copy the compiled library files from dist-newstyle into the current working directory
	// if the dist-newstyle directory does not already exist  this does not work
	// cabal is too clever about cache invalidation and rebuild anyway
	// "postCreateCommand": "[ ! -d ./dist-newstyle ] && cp -r ~/dist-newstyle ./",
	// Configure tool-specific properties.devco
	// "customizations": {},
	"remoteUser": "vscode",
	"containerUser": "vscode",

	// X11 forwarding for headed browser testing
	// 
	// xhost controls access to the X11 display server. By default, the X server
	// only allows connections from the user who started it. Since the container
	// runs as a different user (vscode), it cannot access the host's display
	// without explicit permission. The initializeCommand below runs `xhost +local:`
	// on the host to allow all local connections to the X server, enabling the
	// browser inside the container to render windows on your desktop.
	//
	// Requires xhost installed on Linux host (x11-xserver-utils package).
	// For macOS/Windows, see test/README.md for additional setup steps.
	"runArgs": [
		"-e", "DISPLAY=${localEnv:DISPLAY}",
		"-v", "/tmp/.X11-unix:/tmp/.X11-unix:rw"
	],
	
	// Auto-run xhost on container start for X11 forwarding (runs on host before container starts)
	// Two steps needed:
	// 1. xhost +local: - adds X server access control entry
	// 2. chmod - makes socket accessible to container user (different UID)
	// Note: Using full paths because /bin/sh may have minimal PATH
	"initializeCommand": {
		"xhost": "/usr/bin/xhost +local: 2>&1 || echo 'xhost failed - install x11-xserver-utils on host'",
		"chmod": "/bin/chmod a+rw /tmp/.X11-unix/X* 2>&1 || echo 'chmod X11 socket failed (may need sudo)'"
	},

	"postStartCommand": "bash ./dev/container-start.sh",
	"postAttachCommand": "bash ./dev/container-attach.sh",
	
	

	"customizations": {
		"vscode": {
			"extensions": [
				"alefragnani.Bookmarks",
				"nemesv.copy-file-name",
				"mrmlnc.vscode-duplicate",
				"sleistner.vscode-fileutils",
				"huizhou.githd",
				"donjayamanne.githistory",
				"eamodio.gitlens",
				"haskell.haskell",
				"justusadam.language-haskell",
				"ms-vsliveshare.vsliveshare-pack",
				"christian-kohler.path-intellisense",
				"kylepaulsen.stack-tabs",
				"andyyaldoo.vscode-json",
				"redhat.vscode-yaml",
				"bee.git-temporal-vscode",
				"SanaAjani.taskrunnercode",
				"ms-azuretools.vscode-containers"
			]
		}
	}
}